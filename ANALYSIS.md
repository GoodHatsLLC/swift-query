# SwiftUIQuery Framework Assessment

## Correctness
- **Non-deterministic cache hashing:** `Data.sha256Hash` relies on `Hasher`, which uses a random seed each process and is not a real SHA-256. Persisted entries may get different hashes across launches, breaking observation de-duplication that compares `queryHash` values and leading to unnecessary refetches. Consider using a stable digest like CryptoKit's `SHA256`.【F:Sources/SwiftUIQuery/Cache/QueryCache.swift†L92-L103】【F:Sources/SwiftUIQuery/Cache/QueryCacheEntry.swift†L15-L34】【F:Sources/SwiftUIQuery/Cache/QueryCache.swift†L321-L328】
- **Weak observer cleanup timing:** `QueryClient` only prunes `activeQueries` during invalidation or explicit garbage collection. If a view stops observing without invalidation, the weak wrapper may linger, preventing refetch triggers for subsequent observers of the same key. A periodic cleanup or removal on `stopObserving` would keep active query tracking accurate.【F:Sources/SwiftUIQuery/Core/QueryClient.swift†L47-L123】【F:Sources/SwiftUIQuery/Core/QueryObserver.swift†L51-L115】
- **Error visibility with stale data:** When fetch retries exhaust, `QueryObserver` leaves `status` at `.success` if cached data exists, only updating `error`. Consumers relying on `status` may miss background failures. Surfacing a distinct stale-with-error state or exposing `error` timestamps would improve correctness of UI reactions.【F:Sources/SwiftUIQuery/Observation/QueryObserver.swift†L150-L211】

## Usability
- **Limited mutation ergonomics:** Mutations invalidate tags but lack built-in optimistic helpers beyond callbacks; patterns like rollback require manual wiring. Prebuilt optimistic update utilities or typed contexts could reduce boilerplate for common flows.【F:Sources/SwiftUIQuery/Core/MutationState.swift†L1-L117】
- **Configuration discoverability:** Query option defaults (stale time, cache time, retries) are defined in code but not surfaced in README. Developers may struggle to align expectations without documented defaults and examples for tuning behavior.【F:Sources/SwiftUIQuery/Core/QueryKey.swift†L39-L78】【F:README.md†L5-L158】
- **Testing surface area:** Current tests emphasize tags and cache CRUD; there are no integration-style tests covering observer lifecycles, retry behavior, or invalidation cycles, which are crucial for confidence in production usage.【F:Tests/SwiftUIQueryTests/SwiftQueryTests.swift†L1-L110】【F:Tests/SwiftUIQueryTests/QueryCacheTests.swift†L1-L120】

## Recommendations for Future Improvements
- **Stabilize cache hashing:** Replace the Hasher-based `sha256Hash` with CryptoKit `SHA256` to make `queryHash` deterministic across launches and resilient to collisions. This will keep observation de-duplication reliable for persisted entries.【F:Sources/SwiftUIQuery/Cache/QueryCache.swift†L321-L328】
- **Active observer lifecycle management:** Add cleanup hooks when observers stop, and periodically prune `activeQueries` to ensure invalidations reach currently mounted views without leaking stale weak references.【F:Sources/SwiftUIQuery/Core/QueryClient.swift†L47-L123】【F:Sources/SwiftUIQuery/Core/QueryObserver.swift†L51-L115】
- **Expose background error state:** Extend `QueryState` with a "lastBackgroundError" field or a composite status that differentiates successful-but-stale data with fetch failures, enabling UI to show subtle error indicators while retaining cached data.【F:Sources/SwiftUIQuery/Core/QueryState.swift†L22-L117】【F:Sources/SwiftUIQuery/Observation/QueryObserver.swift†L150-L211】
- **Developer-facing documentation:** Document default `QueryOptions`, retry semantics, and mutation patterns (including optimistic flows) in README or a guide, plus code samples for prefetching/pagination with custom timings to reduce onboarding friction.【F:Sources/SwiftUIQuery/Core/QueryKey.swift†L39-L78】【F:README.md†L5-L158】
- **Broaden automated tests:** Add async integration tests for invalidation cycle detection, observer cancellation, background refetch retries, and mutation-triggered invalidations to guard against regressions in critical control flow paths.【F:Sources/SwiftUIQuery/Core/InvalidationTracker.swift†L1-L200】【F:Tests/SwiftUIQueryTests/QueryCacheTests.swift†L1-L200】
